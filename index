<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Questionnaire Vocal</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
</head>
<body>
  <h1>Questionnaire vocal</h1>

  <!-- Connexion Google -->
  <div id="auth-section">
    <p>Merci de vous connecter pour rÃ©pondre :</p>
    <button onclick="signInWithGoogle()">Se connecter avec Google</button>
  </div>

  <!-- Section question -->
  <div id="question-section" class="hidden">
    <p id="question">Quelle est votre expÃ©rience aujourd'hui ?</p>
    <button onclick="startDictation()">ðŸŽ¤ RÃ©pondre Ã  l'oral</button>
    <p id="response"></p>
  </div>

  <script>
    // ðŸ§© Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBGxs6sUV2lp5bFaEvdV7fLAz6wz4vwoZI",
      authDomain: "questionnairexd.firebaseapp.com",
      projectId: "questionnairexd"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();

    // ðŸŸ¢ Google Sign-In
    function signInWithGoogle() {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider)
        .then(result => {
          console.log("ConnectÃ© :", result.user.email);
          document.getElementById('auth-section').classList.add('hidden');
          document.getElementById('question-section').classList.remove('hidden');
        })
        .catch(error => {
          console.error("Erreur de connexion :", error);
          alert("Erreur : " + error.message);
        });
    }

    // ðŸ§  Airtable config
    const airtableApiKey = "patm67mBcEcBXZeED.4c1588d4b1dfa37df6a155af1e77a3c1cad77ddd380ae9d7937c41ad750d26f2";
    const airtableBaseId = "apprjFOnbLySO8spa";
    const airtableTable = "shriT4asLXyKRlFbt"; 
    const questionId = "q1";

    // ðŸŽ¤ DictÃ©e vocale
    function startDictation() {
      const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
      recognition.lang = 'fr-FR';
      recognition.start();
      recognition.onresult = (event) => {
        const response = event.results[0][0].transcript;
        document.getElementById('response').textContent = "RÃ©ponse : " + response;
        sendToAirtable(response);
      };
    }

    // ðŸ“¨ Envoi vers Airtable
    function sendToAirtable(text) {
      const user = auth.currentUser;
      if (!user) return alert("Pas connectÃ©");

      fetch(`https://api.airtable.com/v0/${airtableBaseId}/${airtableTable}`, {
        method: "POST",
        headers: {
          Authorization: `Bearer ${airtableApiKey}`,
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          records: [{
            fields: {
              Email: user.email,
              Question: questionId,
              RÃ©ponse: text,
              Horodatage: new Date().toISOString()
            }
          }]
        })
      })
      .then(res => res.json())
      .then(data => {
        console.log("EnregistrÃ© :", data);
        alert("RÃ©ponse enregistrÃ©e !");
      })
      .catch(err => {
        console.error("Erreur Airtable :", err);
        alert("Erreur lors de l'envoi.");
      });
    }
  </script>

  <style>
    .hidden { display: none; }
    button { font-size: 1.2em; margin-top: 10px; }
  </style>
</body>
</html>
